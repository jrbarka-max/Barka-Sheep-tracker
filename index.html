<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barka Sheep Tracker - Cloud Synced</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
        }

        .app-container {
            min-height: 100vh;
            background: linear-gradient(to bottom right, #f0fdf4, #d1fae5);
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .app-container {
                padding: 2rem;
            }
        }

        .max-w-container {
            max-width: 72rem;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .header-flex {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #065f46;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #4b5563;
        }

        .cloud-badge {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 0.5rem;
            padding: 0.75rem;
            max-width: 20rem;
        }

        .cloud-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: #1e3a8a;
            margin-bottom: 0.25rem;
        }

        .cloud-text {
            font-size: 0.75rem;
            color: #1e40af;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .sync-indicator.syncing {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }

        .sync-indicator.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-text {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            padding: 0.5rem 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 2px solid transparent;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            color: #6b7280;
        }

        .tab:hover {
            color: #374151;
        }

        .tab.active {
            border-bottom-color: #16a34a;
            color: #15803d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-card {
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid;
        }

        .stat-card.green {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .stat-card.blue {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .stat-card.pink {
            background: #fdf2f8;
            border-color: #fbcfe8;
        }

        .stat-card.amber {
            background: #fffbeb;
            border-color: #fde68a;
        }

        .stat-card.gray {
            background: #f9fafb;
            border-color: #e5e7eb;
        }

        .stat-card.red {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-value.green { color: #15803d; }
        .stat-value.blue { color: #1e40af; }
        .stat-value.pink { color: #be185d; }
        .stat-value.amber { color: #b45309; }
        .stat-value.gray { color: #374151; }
        .stat-value.red { color: #b91c1c; }

        .stat-label {
            font-size: 0.875rem;
            color: #4b5563;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .form-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .col-span-3 {
            grid-column: span 1;
        }

        @media (min-width: 768px) {
            .col-span-3 {
                grid-column: span 3;
            }
        }

        .col-span-2 {
            grid-column: span 1;
        }

        @media (min-width: 768px) {
            .col-span-2 {
                grid-column: span 2;
            }
        }

        .btn {
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #16a34a;
            color: white;
        }

        .btn-primary:hover {
            background: #15803d;
        }

        .btn-secondary {
            background: #2563eb;
            color: white;
        }

        .btn-secondary:hover {
            background: #1d4ed8;
        }

        .btn-secondary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .btn-cloud {
            background: #8b5cf6;
            color: white;
        }

        .btn-cloud:hover {
            background: #7c3aed;
        }

        .btn-cloud:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: #dc2626;
            transition: color 0.2s;
        }

        .btn-icon:hover {
            color: #991b1b;
        }

        .section-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .toolbar-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .search-input {
            padding-left: 2.5rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: #374151;
        }

        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.ram {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.ewe {
            background: #fce7f3;
            color: #be185d;
        }

        .badge.sold {
            background: #dcfce7;
            color: #15803d;
        }

        .badge.died {
            background: #fee2e2;
            color: #b91c1c;
        }

        .text-gray-900 { color: #111827; }
        .text-gray-700 { color: #374151; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-500 { color: #6b7280; }

        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        .capitalize { text-transform: capitalize; }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 20rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 0;
            color: #6b7280;
        }

        .loading {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom right, #f0fdf4, #d1fae5);
        }

        .loading-text {
            color: #15803d;
            font-size: 1.125rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert.success {
            background: #dcfce7;
            border: 1px solid #86efac;
            color: #166534;
        }

        .alert.error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
        }

        .alert.warning {
            background: #fef3c7;
            border: 1px solid #fde047;
            color: #854d0e;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxH91xJ1RubCKLBR_S46j5r9JQ2g0_HqAPpw1DXQz2iMQqip39AlcnYWMyeXLi5y5omiw/exec';

        // Icon components
        const Plus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Cloud = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
            </svg>
        );

        const RefreshCw = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const Download = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Search = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        );

        const ClipboardList = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            </svg>
        );

        const FileText = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
        );

        // Storage implementation
        const storage = {
            get: (key) => {
                try {
                    const value = localStorage.getItem(key);
                    return value ? { value, key } : null;
                } catch (error) {
                    console.error('Storage get error:', error);
                    return null;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                    return { key, value };
                } catch (error) {
                    console.error('Storage set error:', error);
                    return null;
                }
            }
        };

        function BarkaSheepTracker() {
            const [lambs, setLambs] = useState([]);
            const [disposals, setDisposals] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeView, setActiveView] = useState('entry');
            const [syncStatus, setSyncStatus] = useState('synced'); // 'synced', 'syncing', 'error'
            const [syncMessage, setSyncMessage] = useState('');
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [formData, setFormData] = useState({
                tagNumber: '',
                sex: 'ram',
                birthWeight: '',
                eweNumber: '',
                numberBorn: 'single',
                comments: '',
                birthDate: new Date().toISOString().split('T')[0]
            });
            const [disposalFormData, setDisposalFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                tagNumber: '',
                type: 'sold',
                cause: '',
                weight: '',
                buyer: '',
                comments: ''
            });

            useEffect(() => {
                loadData();
                // Auto-sync every 5 minutes
                const interval = setInterval(() => {
                    syncWithCloud();
                }, 300000);
                return () => clearInterval(interval);
            }, []);

            const loadData = () => {
                try {
                    const lambsResult = storage.get('lambs-data');
                    if (lambsResult && lambsResult.value) {
                        setLambs(JSON.parse(lambsResult.value));
                    }
                } catch (error) {
                    console.log('No existing lamb data found');
                }

                try {
                    const disposalsResult = storage.get('disposals-data');
                    if (disposalsResult && disposalsResult.value) {
                        setDisposals(JSON.parse(disposalsResult.value));
                    }
                } catch (error) {
                    console.log('No existing disposal data found');
                }

                try {
                    const lastSync = storage.get('last-sync-time');
                    if (lastSync && lastSync.value) {
                        setLastSyncTime(new Date(lastSync.value));
                    }
                } catch (error) {
                    console.log('No last sync time found');
                }

                setLoading(false);
            };

            const saveLambs = (updatedLambs) => {
                try {
                    storage.set('lambs-data', JSON.stringify(updatedLambs));
                } catch (error) {
                    console.error('Failed to save:', error);
                    alert('Failed to save data. Please try again.');
                }
            };

            const saveDisposals = (updatedDisposals) => {
                try {
                    storage.set('disposals-data', JSON.stringify(updatedDisposals));
                } catch (error) {
                    console.error('Failed to save disposals:', error);
                    alert('Failed to save data. Please try again.');
                }
            };

            const syncWithCloud = async () => {
                if (SCRIPT_URL === 'YOUR_SCRIPT_URL_HERE') {
                    setSyncStatus('error');
                    setSyncMessage('Please configure Google Apps Script URL first');
                    return;
                }

                setSyncStatus('syncing');
                setSyncMessage('Syncing with cloud...');

                try {
                    // First, download data from cloud
                    const downloadResponse = await fetch(`${SCRIPT_URL}?action=download`);
                    const cloudData = await downloadResponse.json();

                    // Merge cloud data with local data
                    let mergedLambs = [...lambs];
                    let mergedDisposals = [...disposals];

                    if (cloudData.lambs && Array.isArray(cloudData.lambs)) {
                        mergedLambs = mergeData(lambs, cloudData.lambs);
                    }

                    if (cloudData.disposals && Array.isArray(cloudData.disposals)) {
                        mergedDisposals = mergeData(disposals, cloudData.disposals);
                    }

                    // Update local state with merged data
                    setLambs(mergedLambs);
                    setDisposals(mergedDisposals);
                    saveLambs(mergedLambs);
                    saveDisposals(mergedDisposals);

                    // Upload local data to cloud using GET request with URL parameters
                    // This avoids CORS issues with POST
                    const uploadData = {
                        lambs: mergedLambs,
                        disposals: mergedDisposals
                    };
                    
                    const uploadUrl = `${SCRIPT_URL}?action=upload&data=${encodeURIComponent(JSON.stringify(uploadData))}`;
                    
                    // Use an image tag trick to bypass CORS for the upload
                    const img = new Image();
                    img.src = uploadUrl;

                    const now = new Date();
                    setLastSyncTime(now);
                    storage.set('last-sync-time', now.toISOString());
                    
                    setSyncStatus('synced');
                    setSyncMessage('Successfully synced with cloud');
                    
                    // Clear success message after 3 seconds
                    setTimeout(() => setSyncMessage(''), 3000);
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncStatus('error');
                    setSyncMessage('Sync failed: ' + error.message);
                }
            };

            const mergeData = (localData, cloudData) => {
                const merged = {};
                
                // Add all local items
                localData.forEach(item => {
                    merged[item.id] = item;
                });

                // Add/update with cloud items
                cloudData.forEach(item => {
                    merged[item.id] = item;
                });

                return Object.values(merged);
            };

            const handleSubmit = (e) => {
                e.preventDefault();

                if (!formData.tagNumber || !formData.birthWeight || !formData.eweNumber) {
                    alert('Please fill in all required fields');
                    return;
                }

                const newLamb = {
                    id: Date.now().toString(),
                    ...formData,
                    birthWeight: parseFloat(formData.birthWeight),
                    dateAdded: new Date().toISOString()
                };

                const updatedLambs = [newLamb, ...lambs];
                setLambs(updatedLambs);
                saveLambs(updatedLambs);

                setFormData({
                    tagNumber: '',
                    sex: 'ram',
                    birthWeight: '',
                    eweNumber: '',
                    numberBorn: 'single',
                    comments: '',
                    birthDate: new Date().toISOString().split('T')[0]
                });

                // Don't auto-sync to prevent data loss - user clicks Sync Now when ready
            };

            const deleteLamb = (id) => {
                if (window.confirm('Are you sure you want to delete this record?')) {
                    const updatedLambs = lambs.filter(lamb => lamb.id !== id);
                    setLambs(updatedLambs);
                    saveLambs(updatedLambs);
                }
            };

            const handleDisposalSubmit = (e) => {
                e.preventDefault();

                if (!disposalFormData.date || !disposalFormData.tagNumber) {
                    alert('Please fill in date and tag number');
                    return;
                }

                if (disposalFormData.type === 'died' && !disposalFormData.cause) {
                    alert('Please provide a cause of death');
                    return;
                }

                if (disposalFormData.type === 'sold' && !disposalFormData.buyer) {
                    alert('Please provide buyer information');
                    return;
                }

                const newDisposal = {
                    id: Date.now().toString(),
                    ...disposalFormData,
                    weight: disposalFormData.weight ? parseFloat(disposalFormData.weight) : null,
                    dateRecorded: new Date().toISOString()
                };

                const updatedDisposals = [newDisposal, ...disposals];
                setDisposals(updatedDisposals);
                saveDisposals(updatedDisposals);

                setDisposalFormData({
                    date: new Date().toISOString().split('T')[0],
                    tagNumber: '',
                    type: 'sold',
                    cause: '',
                    weight: '',
                    buyer: '',
                    comments: ''
                });

                // Don't auto-sync to prevent data loss - user clicks Sync Now when ready
            };

            const deleteDisposal = (id) => {
                if (window.confirm('Are you sure you want to delete this record?')) {
                    const updatedDisposals = disposals.filter(disposal => disposal.id !== id);
                    setDisposals(updatedDisposals);
                    saveDisposals(updatedDisposals);
                }
            };

            const exportToExcel = () => {
                const headers = ['Lamb Tag', 'Birth Date', 'Sex', 'Birth Weight (lbs)', 'Ewe Number', 'Number Born', 'Comments'];
                const csvRows = [headers.join(',')];

                lambs.forEach(lamb => {
                    const row = [
                        lamb.tagNumber,
                        new Date(lamb.birthDate || lamb.dateAdded).toLocaleDateString(),
                        lamb.sex === 'ram' ? 'Ram' : 'Ewe',
                        lamb.birthWeight,
                        lamb.eweNumber,
                        lamb.numberBorn.charAt(0).toUpperCase() + lamb.numberBorn.slice(1),
                        `"${(lamb.comments || '').replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `barka-lambs-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const filteredLambs = lambs.filter(lamb => {
                const search = searchTerm.toLowerCase();
                return (
                    lamb.tagNumber.toLowerCase().includes(search) ||
                    lamb.eweNumber.toLowerCase().includes(search)
                );
            });

            const stats = {
                total: lambs.length,
                rams: lambs.filter(l => l.sex === 'ram').length,
                ewes: lambs.filter(l => l.sex === 'ewe').length,
                avgWeight: lambs.length > 0
                    ? (lambs.reduce((sum, l) => sum + l.birthWeight, 0) / lambs.length).toFixed(1)
                    : 0
            };

            const disposalStats = {
                total: disposals.length,
                sold: disposals.filter(d => d.type === 'sold').length,
                died: disposals.filter(d => d.type === 'died').length,
            };

            const filteredDisposals = disposals.filter(disposal => {
                const search = searchTerm.toLowerCase();
                return (
                    disposal.tagNumber.toLowerCase().includes(search) ||
                    (disposal.buyer && disposal.buyer.toLowerCase().includes(search)) ||
                    (disposal.cause && disposal.cause.toLowerCase().includes(search))
                );
            });

            if (loading) {
                return (
                    <div className="loading">
                        <div className="loading-text">Loading...</div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="max-w-container">
                        <div className="card">
                            <div className="header-flex">
                                <div>
                                    <h1 className="title">Barka Sheep Tracker</h1>
                                    <p className="subtitle">Cloud-synced flock management</p>
                                </div>
                                <div className="cloud-badge">
                                    <p className="cloud-title">☁️ Cloud Sync</p>
                                    <p className="cloud-text">Data syncs automatically across all devices</p>
                                    <div className="sync-status">
                                        <div className={`sync-indicator ${syncStatus}`}></div>
                                        <span className="sync-text">
                                            {lastSyncTime ? `Last sync: ${lastSyncTime.toLocaleTimeString()}` : 'Not synced yet'}
                                        </span>
                                    </div>
                                    <button onClick={syncWithCloud} className="btn btn-cloud" style={{marginTop: '0.5rem', width: '100%'}}>
                                        <RefreshCw />
                                        Sync Now
                                    </button>
                                </div>
                            </div>

                            {syncMessage && (
                                <div className={`alert ${syncStatus === 'error' ? 'error' : 'success'}`} style={{marginTop: '1rem'}}>
                                    {syncMessage}
                                </div>
                            )}

                            <div className="tabs">
                                <button
                                    onClick={() => setActiveView('entry')}
                                    className={`tab ${activeView === 'entry' ? 'active' : ''}`}
                                >
                                    <ClipboardList />
                                    Birth Records
                                </button>
                                <button
                                    onClick={() => setActiveView('disposals')}
                                    className={`tab ${activeView === 'disposals' ? 'active' : ''}`}
                                >
                                    <FileText />
                                    Deaths/Sales
                                </button>
                            </div>

                            {activeView === 'entry' && (
                                <div className="stats-grid">
                                    <div className="stat-card green">
                                        <div className="stat-value green">{stats.total}</div>
                                        <div className="stat-label">Total Lambs</div>
                                    </div>
                                    <div className="stat-card blue">
                                        <div className="stat-value blue">{stats.rams}</div>
                                        <div className="stat-label">Rams</div>
                                    </div>
                                    <div className="stat-card pink">
                                        <div className="stat-value pink">{stats.ewes}</div>
                                        <div className="stat-label">Ewes</div>
                                    </div>
                                    <div className="stat-card amber">
                                        <div className="stat-value amber">{stats.avgWeight}</div>
                                        <div className="stat-label">Avg Weight (lbs)</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {activeView === 'entry' && (
                            <>
                                <div className="card">
                                    <h2 className="section-header">
                                        <Plus />
                                        Add New Lamb
                                    </h2>

                                    <form onSubmit={handleSubmit} className="form-grid">
                                        <div className="form-group">
                                            <label className="form-label">Lamb Tag Number *</label>
                                            <input
                                                type="text"
                                                value={formData.tagNumber}
                                                onChange={(e) => setFormData({...formData, tagNumber: e.target.value})}
                                                className="form-input"
                                                placeholder="e.g., L001 or scan RFID tag"
                                                required
                                                autoComplete="off"
                                            />
                                            <p className="form-hint">Click here and scan RFID tag, or type manually</p>
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">Birth Date *</label>
                                            <input
                                                type="date"
                                                value={formData.birthDate}
                                                onChange={(e) => setFormData({...formData, birthDate: e.target.value})}
                                                className="form-input"
                                                required
                                            />
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">Sex *</label>
                                            <select
                                                value={formData.sex}
                                                onChange={(e) => setFormData({...formData, sex: e.target.value})}
                                                className="form-select"
                                            >
                                                <option value="ram">Ram</option>
                                                <option value="ewe">Ewe</option>
                                            </select>
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">Birth Weight (lbs) *</label>
                                            <input
                                                type="number"
                                                step="0.1"
                                                value={formData.birthWeight}
                                                onChange={(e) => setFormData({...formData, birthWeight: e.target.value})}
                                                className="form-input"
                                                placeholder="e.g., 8.5"
                                                required
                                            />
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">Ewe Number *</label>
                                            <input
                                                type="text"
                                                value={formData.eweNumber}
                                                onChange={(e) => setFormData({...formData, eweNumber: e.target.value})}
                                                className="form-input"
                                                placeholder="e.g., E042"
                                                required
                                            />
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">Number Born *</label>
                                            <select
                                                value={formData.numberBorn}
                                                onChange={(e) => setFormData({...formData, numberBorn: e.target.value})}
                                                className="form-select"
                                            >
                                                <option value="single">Single</option>
                                                <option value="twin">Twin</option>
                                                <option value="triplet">Triplet</option>
                                                <option value="quad">Quad</option>
                                            </select>
                                        </div>

                                        <div className="form-group col-span-3">
                                            <label className="form-label">Comments / Complications</label>
                                            <textarea
                                                value={formData.comments}
                                                onChange={(e) => setFormData({...formData, comments: e.target.value})}
                                                className="form-textarea"
                                                placeholder="e.g., assisted birth, weak, bottle fed, etc."
                                                rows="2"
                                            />
                                        </div>

                                        <div className="col-span-3">
                                            <button type="submit" className="btn btn-primary">
                                                <Plus />
                                                Add Lamb
                                            </button>
                                            <p className="form-hint" style={{marginTop: '0.5rem'}}>Click "Sync Now" button above to upload to cloud</p>
                                        </div>
                                    </form>
                                </div>

                                <div className="card">
                                    <div className="toolbar">
                                        <h2 className="section-header" style={{marginBottom: 0}}>Lamb Records</h2>
                                        <div className="toolbar-actions">
                                            <button
                                                onClick={exportToExcel}
                                                disabled={lambs.length === 0}
                                                className="btn btn-secondary"
                                            >
                                                <Download />
                                                Export CSV
                                            </button>
                                            <div className="search-wrapper">
                                                <div className="search-icon">
                                                    <Search />
                                                </div>
                                                <input
                                                    type="text"
                                                    value={searchTerm}
                                                    onChange={(e) => setSearchTerm(e.target.value)}
                                                    placeholder="Search..."
                                                    className="search-input"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {filteredLambs.length === 0 ? (
                                        <div className="empty-state">
                                            {lambs.length === 0 ? (
                                                <p>No lambs recorded yet. Add your first lamb above!</p>
                                            ) : (
                                                <p>No lambs match your search.</p>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="table-container">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Tag #</th>
                                                        <th>Birth Date</th>
                                                        <th>Sex</th>
                                                        <th>Weight</th>
                                                        <th>Ewe #</th>
                                                        <th>Born</th>
                                                        <th>Comments</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredLambs.map((lamb) => (
                                                        <tr key={lamb.id}>
                                                            <td className="font-medium text-gray-900">{lamb.tagNumber}</td>
                                                            <td className="text-gray-700">
                                                                {new Date(lamb.birthDate || lamb.dateAdded).toLocaleDateString()}
                                                            </td>
                                                            <td>
                                                                <span className={`badge ${lamb.sex}`}>
                                                                    {lamb.sex === 'ram' ? 'Ram' : 'Ewe'}
                                                                </span>
                                                            </td>
                                                            <td className="text-gray-700">{lamb.birthWeight} lbs</td>
                                                            <td className="text-gray-700">{lamb.eweNumber}</td>
                                                            <td>
                                                                <span className="capitalize text-gray-700">{lamb.numberBorn}</span>
                                                            </td>
                                                            <td className="text-gray-600 truncate" title={lamb.comments}>
                                                                {lamb.comments || '—'}
                                                            </td>
                                                            <td>
                                                                <button
                                                                    onClick={() => deleteLamb(lamb.id)}
                                                                    className="btn-icon"
                                                                    title="Delete record"
                                                                >
                                                                    <Trash2 />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {activeView === 'disposals' && (
                            <>
                                <div className="card">
                                    <h2 className="section-header">
                                        <Plus />
                                        Record Death or Sale
                                    </h2>

                                    <form onSubmit={handleDisposalSubmit} className="form-grid">
                                        <div className="form-group">
                                            <label className="form-label">Date *</label>
                                            <input
                                                type="date"
                                                value={disposalFormData.date}
                                                onChange={(e) => setDisposalFormData({...disposalFormData, date: e.target.value})}
                                                className="form-input"
                                                required
                                            />
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">Lamb Tag Number *</label>
                                            <input
                                                type="text"
                                                value={disposalFormData.tagNumber}
                                                onChange={(e) => setDisposalFormData({...disposalFormData, tagNumber: e.target.value})}
                                                className="form-input"
                                                placeholder="e.g., L001 or scan RFID tag"
                                                required
                                                autoComplete="off"
                                            />
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">Type *</label>
                                            <select
                                                value={disposalFormData.type}
                                                onChange={(e) => setDisposalFormData({...disposalFormData, type: e.target.value})}
                                                className="form-select"
                                            >
                                                <option value="sold">Sold</option>
                                                <option value="died">Died</option>
                                            </select>
                                        </div>

                                        {disposalFormData.type === 'died' && (
                                            <div className="form-group col-span-3">
                                                <label className="form-label">Cause of Death *</label>
                                                <input
                                                    type="text"
                                                    value={disposalFormData.cause}
                                                    onChange={(e) => setDisposalFormData({...disposalFormData, cause: e.target.value})}
                                                    className="form-input"
                                                    placeholder="e.g., predator, illness"
                                                    required
                                                />
                                            </div>
                                        )}

                                        {disposalFormData.type === 'sold' && (
                                            <>
                                                <div className="form-group">
                                                    <label className="form-label">Sale Weight (lbs)</label>
                                                    <input
                                                        type="number"
                                                        step="0.1"
                                                        value={disposalFormData.weight}
                                                        onChange={(e) => setDisposalFormData({...disposalFormData, weight: e.target.value})}
                                                        className="form-input"
                                                        placeholder="e.g., 85.5"
                                                    />
                                                </div>

                                                <div className="form-group col-span-2">
                                                    <label className="form-label">Buyer *</label>
                                                    <input
                                                        type="text"
                                                        value={disposalFormData.buyer}
                                                        onChange={(e) => setDisposalFormData({...disposalFormData, buyer: e.target.value})}
                                                        className="form-input"
                                                        placeholder="Buyer name or market"
                                                        required
                                                    />
                                                </div>
                                            </>
                                        )}

                                        <div className="form-group col-span-3">
                                            <label className="form-label">Comments</label>
                                            <textarea
                                                value={disposalFormData.comments}
                                                onChange={(e) => setDisposalFormData({...disposalFormData, comments: e.target.value})}
                                                className="form-textarea"
                                                placeholder="Additional notes..."
                                                rows="2"
                                            />
                                        </div>

                                        <div className="col-span-3">
                                            <button type="submit" className="btn btn-primary">
                                                <Plus />
                                                Add Record
                                            </button>
                                            <p className="form-hint" style={{marginTop: '0.5rem'}}>Click "Sync Now" button above to upload to cloud</p>
                                        </div>
                                    </form>
                                </div>

                                <div className="card">
                                    <div className="toolbar">
                                        <h2 className="section-header" style={{marginBottom: 0}}>Disposal Records</h2>
                                        <div className="search-wrapper">
                                            <div className="search-icon">
                                                <Search />
                                            </div>
                                            <input
                                                type="text"
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                placeholder="Search..."
                                                className="search-input"
                                            />
                                        </div>
                                    </div>

                                    {filteredDisposals.length === 0 ? (
                                        <div className="empty-state">
                                            <p>No disposal records yet.</p>
                                        </div>
                                    ) : (
                                        <div className="table-container">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Tag #</th>
                                                        <th>Type</th>
                                                        <th>Cause/Buyer</th>
                                                        <th>Weight</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredDisposals.map((disposal) => (
                                                        <tr key={disposal.id}>
                                                            <td className="text-gray-700">
                                                                {new Date(disposal.date).toLocaleDateString()}
                                                            </td>
                                                            <td className="font-medium text-gray-900">{disposal.tagNumber}</td>
                                                            <td>
                                                                <span className={`badge ${disposal.type}`}>
                                                                    {disposal.type === 'sold' ? 'Sold' : 'Died'}
                                                                </span>
                                                            </td>
                                                            <td className="text-gray-700">
                                                                {disposal.type === 'sold' ? disposal.buyer : disposal.cause}
                                                            </td>
                                                            <td className="text-gray-700">
                                                                {disposal.weight ? `${disposal.weight} lbs` : '—'}
                                                            </td>
                                                            <td>
                                                                <button
                                                                    onClick={() => deleteDisposal(disposal.id)}
                                                                    className="btn-icon"
                                                                    title="Delete record"
                                                                >
                                                                    <Trash2 />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BarkaSheepTracker />, document.getElementById('root'));
    </script>
</body>
</html>